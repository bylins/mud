name: Multi-Platform Build

on:
  push:
    branches: [ master, world-load-refactoring ]
  pull_request:
    branches: [ master ]

# Cancel previous runs if new push to same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux-matrix:
    name: Linux / GCC / ${{ matrix.config.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Base"
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release"
            packages: ""
            run_tests: true

          - name: "YAML"
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release -DHAVE_YAML=ON"
            packages: "libyaml-cpp-dev"
            run_tests: true

          - name: "SQLite"
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release -DHAVE_SQLITE=ON"
            packages: "libsqlite3-dev"
            run_tests: true

          - name: "Base + Admin API"
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release -DENABLE_ADMIN_API=ON"
            packages: ""
            run_tests: true

          - name: "YAML + Admin API"
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release -DHAVE_YAML=ON -DENABLE_ADMIN_API=ON"
            packages: "libyaml-cpp-dev"
            run_tests: true

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            make \
            libssl-dev \
            libcurl4-gnutls-dev \
            libexpat1-dev \
            gettext \
            unzip \
            cmake \
            gdb \
            libgtest-dev \
            zlib1g-dev \
            libcrypt-dev

      - name: Install config-specific dependencies
        if: matrix.config.packages != ''
        run: |
          sudo apt-get install -y ${{ matrix.config.packages }}

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake ${{ matrix.config.cmake_flags }} ..

      - name: Build
        run: |
          cd build
          make ${{ matrix.config.run_tests && 'tests' || '' }} -j$(nproc)

      - name: Run tests
        if: matrix.config.run_tests
        run: |
          cd build
          ./tests/tests

  build-linux-gcc15:
    name: Linux / GCC 15 / Base
    runs-on: ubuntu-latest

    container:
      image: debian:sid
      options: --user root

    steps:
      - name: Install Git and dependencies
        run: |
          apt-get update
          apt-get install -y git ca-certificates
          git config --global --add safe.directory '*'

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install GCC 15 and build dependencies
        run: |
          apt-get update
          apt-get install -y \
            gcc-15 \
            g++-15 \
            build-essential \
            make \
            libssl-dev \
            libcurl4-gnutls-dev \
            libexpat1-dev \
            gettext \
            unzip \
            cmake \
            gdb \
            libgtest-dev \
            libcrypt-dev

      - name: Show GCC 15 version
        run: |
          gcc-15 --version
          g++-15 --version

      - name: Configure CMake with GCC 15
        run: |
          mkdir -p build
          cd build
          CC=gcc-15 CXX=g++-15 cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build with GCC 15
        run: |
          cd build
          make tests -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ./tests/tests

  build-windows-msvc:
    name: Windows / MSVC / Base
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
          key: vcpkg-msvc-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: vcpkg-msvc-

      - name: Install dependencies with vcpkg
        run: |
          vcpkg install openssl:x64-windows curl:x64-windows expat:x64-windows gtest:x64-windows

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ..

      - name: Build
        run: |
          cd build
          cmake --build . --config Test -j

      - name: Run tests
        run: |
          cd build
          ./tests/Test/tests.exe
          echo "Exit code: $LASTEXITCODE"
          exit $LASTEXITCODE

  build-macos-clang:
    name: macOS / Clang / Base
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install openssl curl expat googletest cmake

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) \
                -DCURL_ROOT=$(brew --prefix curl) ..

      - name: Build
        run: |
          cd build
          make tests -j$(sysctl -n hw.ncpu)

      - name: Run tests
        run: |
          cd build
          ./tests/tests

  build-windows-clang:
    name: Windows / Clang / Base
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
          key: vcpkg-clang-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: vcpkg-clang-

      - name: Install dependencies with vcpkg
        run: |
          vcpkg install openssl:x64-windows curl:x64-windows expat:x64-windows gtest:x64-windows

      - name: Configure CMake with Clang
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ..

      - name: Build
        run: |
          cd build
          cmake --build . --config Release -j

      - name: Run tests
        run: |
          cd build
          ./tests/Release/tests.exe
          echo "Exit code: $LASTEXITCODE"
          exit $LASTEXITCODE

  build-windows-mingw:
    name: Windows / MinGW / Base
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2 / MinGW-w64
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            git
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-expat

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          mkdir -p build
          cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Test -DBUILD_TESTS=OFF ..

      - name: Build
        shell: msys2 {0}
        run: |
          cd build
          ninja -j$(nproc)

  build-cygwin:
    name: Cygwin / GCC / Base
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Cygwin
        uses: cygwin/cygwin-install-action@v6
        with:
          packages: >-
            gcc-g++
            gcc-core
            make
            cmake
            libssl-devel
            libcurl-devel
            libexpat1-devel
            libcrypt-devel
            gettext-devel
            unzip
            git
            wget

      - name: Build and install googletest from source
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd /tmp
          wget https://github.com/google/googletest/archive/refs/tags/v1.14.0.tar.gz
          tar xzf v1.14.0.tar.gz
          cd googletest-1.14.0
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          make install

      - name: Configure CMake
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          git config --global --add safe.directory '*'
          cd "$GITHUB_WORKSPACE/build"
          make tests -j$(nproc)

      - name: Run tests
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd "$GITHUB_WORKSPACE/build"
          ./tests/tests

  build-cygwin-yaml:
    name: Cygwin / GCC / YAML
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Cygwin
        uses: cygwin/cygwin-install-action@v6
        with:
          packages: >-
            gcc-g++
            gcc-core
            make
            cmake
            libssl-devel
            libcurl-devel
            libexpat1-devel
            libcrypt-devel
            gettext-devel
            unzip
            git
            wget

      - name: Build and install googletest from source
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd /tmp
          wget https://github.com/google/googletest/archive/refs/tags/v1.14.0.tar.gz
          tar xzf v1.14.0.tar.gz
          cd googletest-1.14.0
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          make install

      - name: Build and install yaml-cpp from source
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd /tmp
          wget https://github.com/jbeder/yaml-cpp/archive/refs/tags/yaml-cpp-0.7.0.tar.gz
          tar xzf yaml-cpp-0.7.0.tar.gz
          cd yaml-cpp-yaml-cpp-0.7.0
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DYAML_BUILD_SHARED_LIBS=ON -DCMAKE_POLICY_VERSION_MINIMUM=3.5 ..
          make -j$(nproc)
          make install

      - name: Configure CMake
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DHAVE_YAML=ON ..

      - name: Build
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          git config --global --add safe.directory '*'
          cd "$GITHUB_WORKSPACE/build"
          make tests -j$(nproc)

      - name: Run tests
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd "$GITHUB_WORKSPACE/build"
          ./tests/tests

  build-wsl:
    name: WSL / GCC / Base
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-24.04

      - name: Install dependencies in WSL
        shell: wsl-bash {0}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            make \
            libssl-dev \
            libcurl4-gnutls-dev \
            libexpat1-dev \
            gettext \
            unzip \
            cmake \
            gdb \
            libgtest-dev \
            zlib1g-dev \
            libcrypt-dev

      - name: Configure CMake in WSL
        shell: wsl-bash {0}
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build in WSL
        shell: wsl-bash {0}
        run: |
          cd build
          make tests -j$(nproc)

      - name: Run tests in WSL
        shell: wsl-bash {0}
        run: |
          cd build
          ./tests/tests


  build-wsl-yaml:
    name: WSL / GCC / YAML
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-24.04

      - name: Install dependencies in WSL
        shell: wsl-bash {0}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            make \
            libssl-dev \
            libcurl4-gnutls-dev \
            libexpat1-dev \
            gettext \
            unzip \
            cmake \
            gdb \
            libgtest-dev \
            zlib1g-dev \
            libcrypt-dev \
            libyaml-cpp-dev

      - name: Configure CMake in WSL
        shell: wsl-bash {0}
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DHAVE_YAML=ON ..

      - name: Build in WSL
        shell: wsl-bash {0}
        run: |
          cd build
          make tests -j$(nproc)

      - name: Run tests in WSL
        shell: wsl-bash {0}
        run: |
          cd build
          ./tests/tests

  coverage:
    name: Linux / GCC / Coverage
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/world-load-refactoring' || github.ref == 'refs/heads/master' || github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libssl-dev libcurl4-gnutls-dev libexpat1-dev \
            gettext libgtest-dev lcov

      - name: Configure CMake with coverage
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON -DWITH_ASAN=OFF ..

      - name: Build tests
        run: make tests -j$(($(nproc)/2))
        working-directory: build

      - name: Run tests
        run: ./tests/tests
        working-directory: build

      - name: Generate lcov report
        run: |
          lcov --capture --ignore-errors mismatch,negative \
            --directory . \
            --output-file coverage.info
          lcov --remove coverage.info --ignore-errors unused \
            '/usr/*' '*/third_party_libs/*' '*/tests/*' \
            --output-file coverage_filtered.info
        working-directory: build

      - name: Post coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          lcov --summary build/coverage_filtered.info 2>&1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Generate HTML report
        run: |
          genhtml build/coverage_filtered.info \
            --output-directory build/coverage_html

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: build/coverage_filtered.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload HTML report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: build/coverage_html/
          retention-days: 30


  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-linux-matrix, build-linux-gcc15, build-windows-msvc, build-macos-clang, build-windows-clang, build-windows-mingw, build-cygwin, build-wsl, build-cygwin-yaml, build-wsl-yaml]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "## Build Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Linux Configurations" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Base | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| With Tests | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML + Admin API | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML + Tests | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQLite | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQLite + Tests | ${{ needs.build-linux-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Linux GCC 15" >> $GITHUB_STEP_SUMMARY
          echo "| Compiler | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GCC 15 (Debian Sid container) | ${{ needs.build-linux-gcc15.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Other Platforms" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| macOS (Clang) | ${{ needs.build-macos-clang.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows (MSVC) | ${{ needs.build-windows-msvc.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows (Clang) | ${{ needs.build-windows-clang.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows (MinGW) | ${{ needs.build-windows-mingw.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cygwin | ${{ needs.build-cygwin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WSL | ${{ needs.build-wsl.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** All jobs are hard-failures -- a red build means something is broken." >> $GITHUB_STEP_SUMMARY
