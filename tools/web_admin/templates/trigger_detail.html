{% extends "base.html" %}

{% block title %}Триггер #{{ trig.vnum }} - Былины MUD{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs-bar">
    <div class="max-w-[1280px] mx-auto px-6 py-2.5">
        <div class="flex items-center gap-2 font-inter text-sm text-ink-muted">
            <a href="{{ url_for('index') }}">Главная</a>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #d4c49a;">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
            <a href="{{ url_for('triggers_list', zone=trig.vnum // 100) }}">Триггеры</a>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #d4c49a;">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
            <span class="text-ink-light">Триггер #{{ trig.vnum }}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}

    <!-- Page Header -->
    <div class="page-header" style="margin-bottom: 8px;">
        <div>
            <h2 class="font-serif-display" style="font-size: 28px;">
                Триггер <span class="text-amber-700">#{{ trig.vnum }}</span>
            </h2>
            <p class="page-subtitle" style="margin-top: 4px;">
                {{ trig.name|default('Без названия') }}
            </p>
        </div>

        <div style="display: flex; gap: 12px;">
            <a href="{{ url_for('trigger_edit', vnum=trig.vnum) }}" class="btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Редактировать
            </a>

            <a href="{{ url_for('triggers_list', zone=trig.vnum // 100) }}" class="btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                К списку
            </a>
        </div>
    </div>

    <!-- Ornamental divider -->
    <div class="ornament-divider">
        <div class="ornament-divider-inner">
            <div class="ornament-line ornament-line-left"></div>
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="opacity: 0.5;">
                <path d="M10 2L12 8L18 8L13 12L15 18L10 14L5 18L7 12L2 8L8 8Z"/>
            </svg>
            <div class="ornament-line ornament-line-right"></div>
        </div>
    </div>

    <!-- SECTION 1: Basic Info -->
    <div class="parchment-section">
        <div class="parchment-section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
            Основная информация
        </div>

        <div class="detail-grid detail-grid-2">
            <div class="detail-field">
                <div class="detail-field-label">Vnum</div>
                <div class="detail-field-value">{{ trig.vnum }}</div>
            </div>

            <div class="detail-field">
                <div class="detail-field-label">Название</div>
                <div class="detail-field-value{% if not trig.name %} empty{% endif %}">
                    {{ trig.name|default('Не задано') }}
                </div>
            </div>

            <div class="detail-field">
                <div class="detail-field-label">Тип привязки (attach type)</div>
                <div class="detail-field-value">
                    {% if trig.attach_type == 0 %}0 - К мобу (MOB)
                    {% elif trig.attach_type == 1 %}1 - К предмету (OBJ)
                    {% elif trig.attach_type == 2 %}2 - К комнате (WLD)
                    {% else %}{{ trig.attach_type }}{% endif %}
                </div>
            </div>

            <div class="detail-field">
                <div class="detail-field-label">Тип триггера (trigger type)</div>
                <div class="detail-field-value">
                    <div style="margin-bottom: 6px;">
                        <strong>0x{{ '%X' % trig.trigger_type }}</strong>
                        <span style="color: #8a7b6b;">(dec: {{ trig.trigger_type }})</span>
                    </div>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; font-family: 'Inter', sans-serif; font-size: 13px; line-height: 1.8; margin-top: 8px;">
                        {# Decode flags based on attach_type #}
                        {% if trig.attach_type == 0 %}{# MOB #}
                            {% if trig.trigger_type & 1 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x1</span><span style="color: #2d241e;">Random Global</span>{% endif %}
                            {% if trig.trigger_type & 2 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x2</span><span style="color: #2d241e;">Random</span>{% endif %}
                            {% if trig.trigger_type & 4 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x4</span><span style="color: #2d241e;">Command</span>{% endif %}
                            {% if trig.trigger_type & 8 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x8</span><span style="color: #2d241e;">Speech</span>{% endif %}
                            {% if trig.trigger_type & 16 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x10</span><span style="color: #2d241e;">Act</span>{% endif %}
                            {% if trig.trigger_type & 32 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x20</span><span style="color: #2d241e;">Death</span>{% endif %}
                            {% if trig.trigger_type & 64 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x40</span><span style="color: #2d241e;">Greet</span>{% endif %}
                            {% if trig.trigger_type & 128 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x80</span><span style="color: #2d241e;">Greet All</span>{% endif %}
                            {% if trig.trigger_type & 256 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x100</span><span style="color: #2d241e;">Entry</span>{% endif %}
                            {% if trig.trigger_type & 512 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x200</span><span style="color: #2d241e;">Receive</span>{% endif %}
                            {% if trig.trigger_type & 1024 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x400</span><span style="color: #2d241e;">Fight</span>{% endif %}
                            {% if trig.trigger_type & 2048 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x800</span><span style="color: #2d241e;">Hit Percent</span>{% endif %}
                            {% if trig.trigger_type & 4096 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x1000</span><span style="color: #2d241e;">Bribe</span>{% endif %}
                            {% if trig.trigger_type & 8192 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x2000</span><span style="color: #2d241e;">Load</span>{% endif %}
                            {% if trig.trigger_type & 16384 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x4000</span><span style="color: #2d241e;">Kill</span>{% endif %}
                            {% if trig.trigger_type & 32768 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x8000</span><span style="color: #2d241e;">Damage</span>{% endif %}
                            {% if trig.trigger_type & 65536 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x10000</span><span style="color: #2d241e;">Greet PC</span>{% endif %}
                            {% if trig.trigger_type & 131072 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x20000</span><span style="color: #2d241e;">Greet PC All</span>{% endif %}
                            {% if trig.trigger_type & 262144 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x40000</span><span style="color: #2d241e;">Income</span>{% endif %}
                            {% if trig.trigger_type & 524288 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x80000</span><span style="color: #2d241e;">Income PC</span>{% endif %}
                            {% if trig.trigger_type & 1048576 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x100000</span><span style="color: #2d241e;">Start Fight</span>{% endif %}
                            {% if trig.trigger_type & 2097152 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x200000</span><span style="color: #2d241e;">Round Num</span>{% endif %}
                            {% if trig.trigger_type & 4194304 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x400000</span><span style="color: #2d241e;">Cast</span>{% endif %}
                            {% if trig.trigger_type & 8388608 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x800000</span><span style="color: #2d241e;">Timechange</span>{% endif %}
                        {% elif trig.attach_type == 1 %}{# OBJ #}
                            {% if trig.trigger_type & 1 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x1</span><span style="color: #2d241e;">Random Global</span>{% endif %}
                            {% if trig.trigger_type & 2 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x2</span><span style="color: #2d241e;">Random</span>{% endif %}
                            {% if trig.trigger_type & 4 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x4</span><span style="color: #2d241e;">Command</span>{% endif %}
                            {% if trig.trigger_type & 8 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x8</span><span style="color: #2d241e;">Purge</span>{% endif %}
                            {% if trig.trigger_type & 16 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x10</span><span style="color: #2d241e;">Fight</span>{% endif %}
                            {% if trig.trigger_type & 32 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x20</span><span style="color: #2d241e;">Timer</span>{% endif %}
                            {% if trig.trigger_type & 64 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x40</span><span style="color: #2d241e;">Get</span>{% endif %}
                            {% if trig.trigger_type & 128 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x80</span><span style="color: #2d241e;">Drop</span>{% endif %}
                            {% if trig.trigger_type & 256 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x100</span><span style="color: #2d241e;">Give</span>{% endif %}
                            {% if trig.trigger_type & 512 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x200</span><span style="color: #2d241e;">Wear</span>{% endif %}
                            {% if trig.trigger_type & 2048 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x800</span><span style="color: #2d241e;">Remove</span>{% endif %}
                            {% if trig.trigger_type & 8192 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x2000</span><span style="color: #2d241e;">Load</span>{% endif %}
                            {% if trig.trigger_type & 16384 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x4000</span><span style="color: #2d241e;">Unlock</span>{% endif %}
                            {% if trig.trigger_type & 32768 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x8000</span><span style="color: #2d241e;">Open</span>{% endif %}
                            {% if trig.trigger_type & 65536 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x10000</span><span style="color: #2d241e;">Lock</span>{% endif %}
                            {% if trig.trigger_type & 131072 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x20000</span><span style="color: #2d241e;">Close</span>{% endif %}
                            {% if trig.trigger_type & 262144 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x40000</span><span style="color: #2d241e;">Pick</span>{% endif %}
                            {% if trig.trigger_type & 524288 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x80000</span><span style="color: #2d241e;">Greet All PC</span>{% endif %}
                            {% if trig.trigger_type & 1048576 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x100000</span><span style="color: #2d241e;">Timechange</span>{% endif %}
                            {% if trig.trigger_type & 2097152 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x200000</span><span style="color: #2d241e;">Put</span>{% endif %}
                        {% elif trig.attach_type == 2 %}{# WLD #}
                            {% if trig.trigger_type & 1 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x1</span><span style="color: #2d241e;">Random Global</span>{% endif %}
                            {% if trig.trigger_type & 2 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x2</span><span style="color: #2d241e;">Random</span>{% endif %}
                            {% if trig.trigger_type & 4 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x4</span><span style="color: #2d241e;">Command</span>{% endif %}
                            {% if trig.trigger_type & 8 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x8</span><span style="color: #2d241e;">Speech</span>{% endif %}
                            {% if trig.trigger_type & 16 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x10</span><span style="color: #2d241e;">Enter PC</span>{% endif %}
                            {% if trig.trigger_type & 32 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x20</span><span style="color: #2d241e;">Reset</span>{% endif %}
                            {% if trig.trigger_type & 64 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x40</span><span style="color: #2d241e;">Enter</span>{% endif %}
                            {% if trig.trigger_type & 128 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x80</span><span style="color: #2d241e;">Drop</span>{% endif %}
                            {% if trig.trigger_type & 256 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x100</span><span style="color: #2d241e;">Unlock</span>{% endif %}
                            {% if trig.trigger_type & 512 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x200</span><span style="color: #2d241e;">Open</span>{% endif %}
                            {% if trig.trigger_type & 1024 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x400</span><span style="color: #2d241e;">Lock</span>{% endif %}
                            {% if trig.trigger_type & 2048 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x800</span><span style="color: #2d241e;">Close</span>{% endif %}
                            {% if trig.trigger_type & 4096 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x1000</span><span style="color: #2d241e;">Pick</span>{% endif %}
                            {% if trig.trigger_type & 8192 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x2000</span><span style="color: #2d241e;">Timechange</span>{% endif %}
                            {% if trig.trigger_type & 16384 %}<span style="text-align: right; color: #b45309; font-family: 'Courier New', monospace; font-weight: 600;">0x4000</span><span style="color: #2d241e;">Kill PC</span>{% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="detail-field">
                <div class="detail-field-label">Числовой аргумент (narg)</div>
                <div class="detail-field-value">{{ trig.narg if trig.narg is defined else '--' }}</div>
            </div>

            <div class="detail-field">
                <div class="detail-field-label">Текстовый аргумент (arglist)</div>
                <div class="detail-field-value{% if not trig.arglist %} empty{% endif %}">
                    {{ trig.arglist|default('Не задано') }}
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION 2: Script Commands -->
    <div class="parchment-section">
        <div class="parchment-section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>
            Тело скрипта (DG commands)
        </div>

        {% if trig.commands and trig.commands|length > 0 %}
        <div style="background: #faf8f3; border: 1px solid #e7dac3; border-radius: 6px; padding: 16px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; overflow-x: auto;">{% for cmd in trig.commands %}{{ cmd }}
{% endfor %}</div>
        {% else %}
        <div class="detail-field-value empty">Скрипт пуст</div>
        {% endif %}
    </div>

    <!-- Bottom Actions -->
    <div style="display: flex; gap: 12px; padding-top: 8px;">
        <a href="{{ url_for('trigger_edit', vnum=trig.vnum) }}" class="btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Редактировать
        </a>

        <a href="{{ url_for('triggers_list', zone=trig.vnum // 100) }}" class="btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Назад к списку
        </a>
    </div>

{% endblock %}
