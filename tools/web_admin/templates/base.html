<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Былины MUD - Админка{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'serif-display': ['"Playfair Display"', 'Georgia', 'serif'],
                        'inter': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                    },
                    colors: {
                        parchment: {
                            50: '#fdf6e3',
                            100: '#f9f0d6',
                            200: '#f4ead5',
                            300: '#e8d9b8',
                            400: '#d4c49a',
                        },
                        ink: {
                            DEFAULT: '#2d241e',
                            light: '#5a4d3f',
                            muted: '#8a7b6b',
                        },
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>
<body class="bg-parchment-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-[#2a1f14] border-b-4 border-double border-amber-900/40">
        <div class="max-w-[1280px] mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- Logo / Brand Mark -->
                <a href="{{ url_for('index') }}" class="w-10 h-10 rounded-lg bg-amber-800/30 flex items-center justify-center flex-shrink-0 hover:bg-amber-800/40 transition-colors" style="text-decoration: none;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#d4a853" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                </a>
                <div>
                    <h1 class="font-serif-display text-xl font-semibold text-[#e8d9b8] tracking-wide leading-tight">
                        Былины МПМ
                    </h1>
                    <div class="font-inter text-xs text-[#a89478] tracking-wider uppercase mt-0.5">
                        Админская панель
                    </div>
                </div>
            </div>

            {% if session.get('username') %}
            <div class="flex items-center gap-4">
                <div class="font-inter text-sm text-[#a89478]">
                    <span class="text-[#d4a853]">{{ session.get('username') }}</span>
                </div>
                <a href="{{ url_for('logout') }}"
                   class="font-inter text-xs font-medium text-[#a89478] hover:text-[#e8d9b8] border border-amber-800/30 hover:border-amber-700/50 rounded-md px-3 py-1.5 transition-all duration-150"
                   style="text-decoration: none;">
                    Выход
                </a>
            </div>
            {% endif %}
        </div>
    </header>

    {% if session.get('username') %}
    <!-- Navigation -->
    <nav class="bg-[#352a1e] border-b-2 border-amber-900/20 shadow-sm">
        <div class="max-w-[1280px] mx-auto px-6">
            <div class="flex items-center gap-1 overflow-x-auto">
                {% set nav_items = [
                    ('index', 'Главная', none),
                    ('zones_list', 'Зоны', none),
                    ('mobs_list', 'Мобы', {'zone': 1}),
                    ('objects_list', 'Предметы', {'zone': 1}),
                    ('rooms_list', 'Комнаты', {'zone': 1}),
                    ('triggers_list', 'Триггеры', {'zone': 1}),
                ] %}

                {% for route, label, params in nav_items %}
                <a href="{{ url_for(route, **(params or {})) }}"
                   style="text-decoration: none;"
                   class="font-inter text-sm font-medium px-4 py-3 text-[#c4b094] hover:text-[#e8d9b8] hover:bg-amber-900/15 border-b-2 border-transparent hover:border-[#d4a853]/60 transition-all duration-150 whitespace-nowrap
                          {% if request.endpoint == route %} text-[#e8d9b8] border-[#d4a853]/80 bg-amber-900/10{% endif %}">
                    {{ label }}
                </a>
                {% endfor %}
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Breadcrumbs -->
    {% block breadcrumbs %}{% endblock %}

    <!-- Main Content -->
    <main class="flex-1">
        <div class="max-w-[1280px] mx-auto px-6 py-8">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t-2 border-double border-amber-900/15 bg-[#f0e6cf]">
        <div class="max-w-[1280px] mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="font-inter text-xs text-ink-muted">
                    Былины MUD Admin Panel
                </div>
                <div class="font-inter text-xs text-ink-muted">
                    Powered by Flask & OLC API
                </div>
            </div>
        </div>
    </footer>

    <script>
        // MUD Color Code Rendering
        function renderMudColors(text) {
            if (!text) return text;

            const colorMap = {
                'K': 'black',
                'k': 'black-bright',
                'B': 'blue',
                'b': 'blue-bright',
                'C': 'cyan',
                'c': 'cyan-bright',
                'Y': 'yellow',
                'y': 'yellow-bright',
                'M': 'magenta',
                'm': 'magenta-bright',
                'W': 'white',
                'w': 'white-bright',
                'R': 'red',
                'r': 'red-bright',
                'G': 'green',
                'g': 'green-bright',
                'n': 'normal'
            };

            // Replace color codes with spans but KEEP the codes visible OUTSIDE spans
            let result = '';
            let currentColor = null;
            let i = 0;

            while (i < text.length) {
                if (text[i] === '&' && i + 1 < text.length) {
                    const code = text[i + 1];

                    // Check if it's a color code
                    if (colorMap[code]) {
                        // Close previous span if any
                        if (currentColor) {
                            result += '</span>';
                        }

                        // Add the code OUTSIDE the span (visible but not colored)
                        result += '&' + code;

                        // Open new span (unless it's reset)
                        if (code === 'n') {
                            currentColor = null;
                        } else {
                            currentColor = colorMap[code];
                            result += '<span class="mud-color-' + currentColor + '">';
                        }

                        i += 2; // Skip &X
                        continue;
                    } else if (code >= '0' && code <= '9') {
                        // Numeric codes - keep them outside too
                        if (currentColor) {
                            result += '</span>';
                            currentColor = null;
                        }
                        result += '&' + code;
                        i += 2;
                        continue;
                    }
                }

                result += text[i];
                i++;
            }

            // Close any open span
            if (currentColor) {
                result += '</span>';
            }

            return result;
        }

        // Apply MUD colors to elements with class 'mud-colorize'
        function applyMudColors() {
            document.querySelectorAll('.mud-colorize').forEach(function(el) {
                // Skip if already processed
                if (el.dataset.colorized) return;

                // Get raw text content (no HTML entities, just actual text)
                const text = el.textContent;

                // Store original for potential re-processing
                el.dataset.originalText = text;
                el.dataset.colorized = 'true';

                // Just apply colors, keep codes visible, don't touch newlines
                const colored = renderMudColors(text);
                el.innerHTML = colored;
            });
        }

        // Table sorting utility
        function sortTable(table, columnIndex, dataType = 'text') {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const th = table.querySelectorAll('th')[columnIndex];
            const currentOrder = th.getAttribute('data-sort-order') || 'none';

            // Clear all sort indicators
            table.querySelectorAll('th').forEach(header => {
                header.setAttribute('data-sort-order', 'none');
                header.classList.remove('sorted-asc', 'sorted-desc');
            });

            // Determine new sort order
            let newOrder = 'asc';
            if (currentOrder === 'asc') {
                newOrder = 'desc';
            }

            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.querySelectorAll('td')[columnIndex];
                const bCell = b.querySelectorAll('td')[columnIndex];

                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();

                // Extract numeric values if data type is numeric
                if (dataType === 'numeric') {
                    aValue = parseInt(aValue.replace(/[^\d-]/g, '')) || 0;
                    bValue = parseInt(bValue.replace(/[^\d-]/g, '')) || 0;
                } else {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                if (aValue < bValue) return newOrder === 'asc' ? -1 : 1;
                if (aValue > bValue) return newOrder === 'asc' ? 1 : -1;
                return 0;
            });

            // Update table
            rows.forEach(row => tbody.appendChild(row));

            // Update sort indicator
            th.setAttribute('data-sort-order', newOrder);
            th.classList.add(newOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }

        // Table search/filter utility
        function filterTable(searchInput, table) {
            const searchTerm = searchInput.value.toLowerCase();
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    </script>

    {% block scripts %}{% endblock %}

</body>
</html>
